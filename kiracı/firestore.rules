rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Accounts: owner can read/write their own account doc; authenticated can list (admin stats)
    match /accounts/{accountId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == accountId;
    }

    // Members subcollection + collectionGroup
    match /{path=**}/members/{memberId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/members/{memberId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }

    // Admin subcollections (holidays, settings etc.)
    match /accounts/{accountId}/admin/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }
    match /accounts/{accountId}/admin/{docId}/{sub}/{subId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }

    // Audit logs (collectionGroup)
    match /{path=**}/audit_logs/{logId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/audit_logs/{logId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }

    // Properties subcollection
    match /accounts/{accountId}/properties/{propertyId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }

    // Agent permissions (collectionGroup queries need top-level match)
    match /{path=**}/agent_permissions/{permId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/properties/{propertyId}/agent_permissions/{permId} {
      allow read, write: if request.auth != null;
    }

    // Contracts â€” authenticated users can read (for collectionGroup tenant queries)
    match /{path=**}/contracts/{contractId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/contracts/{contractId} {
      allow read, write: if request.auth != null;
    }

    // Invoices (collectionGroup queries)
    match /{path=**}/invoices/{invoiceId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/contracts/{contractId}/invoices/{invoiceId} {
      allow read, write: if request.auth != null;
    }

    // Requests (collectionGroup queries)
    match /{path=**}/requests/{requestId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/contracts/{contractId}/requests/{requestId} {
      allow read, write: if request.auth != null;
    }

    // Upfront offers
    match /{path=**}/upfront_offers/{offerId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/contracts/{contractId}/upfront_offers/{offerId} {
      allow read, write: if request.auth != null;
    }

    // Request chat messages
    match /accounts/{accountId}/contracts/{contractId}/requests/{requestId}/messages/{messageId} {
      allow read, write: if request.auth != null;
    }

    // Wallet subcollection (collectionGroup queries)
    match /{path=**}/wallet/{entryId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/wallet/{entryId} {
      allow read: if request.auth != null && request.auth.uid == accountId;
      allow write: if false;
    }

    // Withdrawals subcollection
    match /accounts/{accountId}/withdrawals/{withdrawalId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }

    // Admin withdrawals (admin can read/write, users can create)
    match /admin_withdrawals/{withdrawalId} {
      allow read, write: if request.auth != null;
    }

    // Payouts (collectionGroup queries)
    match /{path=**}/payouts/{payoutId} {
      allow read: if request.auth != null;
    }
    match /accounts/{accountId}/payouts/{payoutId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }

    // Notifications subcollection
    match /accounts/{accountId}/notifications/{notifId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }

    // Standalone payments
    match /accounts/{accountId}/standalone_payments/{paymentId} {
      allow read, write: if request.auth != null && request.auth.uid == accountId;
    }
  }
}
